<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Sagi - Integração iSat</title>
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="../assets/css/styles.css" />
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script> -->
  </head>
  <body>
    <div id="root">
      <div class="row">
        <div class="child-row">
          <div style="display: flex; justify-content: space-between">
            <h1>Gerais:</h1>
            <button id="run_generals" onClick="startStopLogs('generals')">
              Stop Logs
            </button>
          </div>

          <div class="boxLogs" id="boxLogs_generals"><ul></ul></div>
        </div>
        <div class="child-row">
          <div style="display: flex; justify-content: space-between">
            <h1>Veículos:</h1>
            <button id="run_vehicles" onClick="startStopLogs('vehicles')">
              Stop Logs
            </button>
          </div>

          <div class="boxLogs" id="boxLogs_vehicles"><ul></ul></div>
        </div>
      </div>
      <div class="row">
        <div class="child-row">
          <div style="display: flex; justify-content: space-between">
            <h1>Referências:</h1>
            <button id="run_references" onClick="startStopLogs('references')">
              Stop Logs
            </button>
          </div>

          <div class="boxLogs" id="boxLogs_references"><ul></ul></div>
        </div>
        <div class="child-row">
          <div style="display: flex; justify-content: space-between">
            <h1>Ordens:</h1>
            <button id="run_orders" onClick="startStopLogs('orders')">
              Stop Logs
            </button>
          </div>

          <div class="boxLogs" id="boxLogs_orders"><ul></ul></div>
        </div>
      </div>
      <div class="row">
        <div class="child-row">
          <div style="display: flex; justify-content: space-between">
            <h1>Caçambas/Tipos:</h1>
            <button id="run_containers" onClick="startStopLogs('containers')">
              Stop Logs
            </button>
          </div>

          <div class="boxLogs" id="boxLogs_containers"><ul></ul></div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      const { ipcRenderer } = require("electron");
      const { v4: uuidv4 } = require("uuid");

      const logs = {
        containers: [],
        vehicles: [],
        references: [],
        orders: [],
        generals: [],
      };
      const runs = {
        containers: true,
        vehicles: true,
        references: true,
        orders: true,
        generals: true,
      };

      ipcRenderer.on("log", (event, arg) => {
        if (runs[arg.type]) {
          createLog(arg.log, arg.type);
        }
      });

      /* ipcRenderer.on("toggle_all_logs", (event, arg) => {
        runs["vehicles"] = arg.value;
        runs["references"] = arg.value;
        runs["orders"] = arg.value;
        runs["generals"] = arg.value;

        if (arg.value) {
          document
            .querySelector(`button#run_vehicles`)
            .classList.remove("btn-success");
          document
            .querySelector(`button#run_references`)
            .classList.remove("btn-success");
          document
            .querySelector(`button#run_orders`)
            .classList.remove("btn-success");
          document
            .querySelector(`button#run_generals`)
            .classList.remove("btn-success");
        } else {
          logs["vehicles"] = [];
          logs["references"] = [];
          logs["orders"] = [];
          logs["generals"] = [];

          const ul_vehicles = document.querySelector("#boxLogs_vehicles ul");
          const lis_vehicles = ul_vehicles.getElementsByTagName("li");

          const ul_references = document.querySelector(
            "#boxLogs_references ul"
          );
          const lis_references = ul_references.getElementsByTagName("li");

          const ul_orders = document.querySelector("#boxLogs_orders ul");
          const lis_orders = ul_orders.getElementsByTagName("li");

          const ul_generals = document.querySelector("#boxLogs_generals ul");
          const lis_generals = ul_generals.getElementsByTagName("li");

          for (var x = lis_vehicles.length - 1; x >= 0; x--) {
            ul_vehicles.removeChild(lis_vehicles[x]);
          }
          for (var x = lis_references.length - 1; x >= 0; x--) {
            ul_references.removeChild(lis_references[x]);
          }
          for (var x = lis_orders.length - 1; x >= 0; x--) {
            ul_orders.removeChild(lis_orders[x]);
          }
          for (var x = lis_generals.length - 1; x >= 0; x--) {
            ul_generals.removeChild(lis_generals[x]);
          }

          document
            .querySelector(`button#run_vehicles`)
            .classList.add("btn-success");
          document
            .querySelector(`button#run_references`)
            .classList.add("btn-success");
          document
            .querySelector(`button#run_orders`)
            .classList.add("btn-success");
          document
            .querySelector(`button#run_generals`)
            .classList.add("btn-success");
        }
      }); */

      function createLog(description, type) {
        const id = uuidv4();

        const ul = document.querySelector(`#boxLogs_${type} ul`);
        const li = document.createElement("li");

        li.setAttribute("id", id);
        li.appendChild(document.createTextNode(description));
        ul.appendChild(li);

        ul.scrollTop = ul.scrollHeight;

        logs[type].push({ id });

        if (logs[type].length >= 1000) {
          const _id = logs[type].shift();

          document.getElementById(_id.id).remove();
        }
      }

      function startStopLogs(type) {
        runs[type] = !runs[type];
        const button = document.querySelector(`button#run_${type}`);

        button.innerHTML = runs[type] ? "Stop Logs" : "Start Logs";
        button.classList.toggle("btn-success");
      }

      /* const socket = io("https://websocket.sagisolutions.com:3000", {
        transports: ["websocket"],
      });

      ipcRenderer.on("nomegeral", (event, arg) => {
        socket.emit("join", [arg.nomeragal]);
      });

      socket.on("event", (event) => {
        const notification = {
          title: null,
          body: null,
        };

        if (
          event.type == "GTIGN" ||
          event.type == "GTFRI" ||
          event.type == "ONSTOP" ||
          event.type == "GTMPF" ||
          event.type == "OUTSIDETHEFENCE" ||
          event.type == "INSIDETHEFENCE"
        ) {
          notification.title = event.placa + " - " + event.title;
          notification.body = "Data/Hora: " + event.datahora;
        }

        if (event.type == "GTHBM") {
          notification.title = event.placa + " - " + event.title;
          notification.body =
            "Data/Hora: " +
            event.datahora +
            " e Velocidade: " +
            event.speed +
            " Km/h";
        }

        new Notification(notification.title, {
          body: notification.body,
          icon: "../assets/image/logo.png",
        });
      }); */
    </script>

    <div id="notification" class="hidden">
      <p id="message"></p>
    </div>
    <script>
      const notification = document.getElementById("notification");
      const message = document.getElementById("message");

      ipcRenderer.on("update_available", () => {
        ipcRenderer.removeAllListeners("update_available");
        message.innerText = "A new update is available. Downloading now...";
        notification.classList.remove("hidden");
      });

      ipcRenderer.on("update_downloaded", () => {
        ipcRenderer.removeAllListeners("update_downloaded");
        message.innerText =
          "Update Downloaded. It will be installed on restart. Restart now?";
        notification.classList.remove("hidden");
        ipcRenderer.send("restart_app");
      });
    </script>
  </body>
</html>
